(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[261],{1767:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>y});var n=a(5155),s=a(2619),r=a.n(s),i=a(2115),l=a(6212),d=a(6405),c=a(2127),o=a(2507);function u(e,t,a){let n=t.slice().sort(),s=e.createEIP712(c.j,n,0,0),r=o.z.hash(s.domain,{UserDecryptRequestVerification:s.types.UserDecryptRequestVerification},s.message);return"".concat(a,":").concat(r)}async function m(e,t,a,n){var s;let r=null!=(s=null==n?void 0:n.storage)?s:window.localStorage,i=await a.getAddress(),l=u(e,t,i);try{(null==n?void 0:n.forceResign)&&"function"==typeof r.removeItem&&r.removeItem(l);let e=r.getItem(l);if(e){let t=JSON.parse(e);if(t&&"string"==typeof t.publicKey&&"string"==typeof t.privateKey&&"string"==typeof t.signature)return t}}catch(e){}let d=t.slice().sort(),{publicKey:c,privateKey:o}=e.generateKeypair(),m=Math.floor(Date.now()/1e3),p=e.createEIP712(c,d,m,365),y={publicKey:c,privateKey:o,signature:await a.signTypedData(p.domain,{UserDecryptRequestVerification:p.types.UserDecryptRequestVerification},p.message),contractAddresses:d,userAddress:i,startTimestamp:m,durationDays:365};try{r.setItem(l,JSON.stringify(y))}catch(e){}return y}async function p(e,t,a){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:window.localStorage;try{let s=await a.getAddress(),r=u(e,t,s);"function"==typeof n.removeItem&&n.removeItem(r)}catch(e){}}function y(){let{contract:e,fhevmInstance:t,signer:a,address:s,isConnected:c}=(0,l.X)(),[o,u]=(0,i.useState)(!1),[y,h]=(0,i.useState)([]),[x,g]=(0,i.useState)(null),[v,f]=(0,i.useState)(null),[b,w]=(0,i.useState)(""),[N,j]=(0,i.useState)(!1),[D,S]=(0,i.useState)(!1),[T,A]=(0,i.useState)(""),[C,k]=(0,i.useState)({}),[E,M]=(0,i.useState)(!1),[I,_]=(0,i.useState)(null);(0,i.useEffect)(()=>{!async function(){if(e&&s){u(!0);try{let t=await e.getUserActions(s);h(t);let a=await e.getUserEncryptedSum(s),n="string"==typeof a||(0,d.Lo)(a)?a:(0,d.c$)(a);g(n)}catch(e){}u(!1)}}()},[e,s]);let K=y.length,U=Array.from(y).toReversed?Array.from(y).toReversed():Array.from(y).reverse();return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)("main",{className:"min-h-screen bg-gradient-to-br from-green-50 via-blue-50 to-green-100",children:[(0,n.jsx)("nav",{className:"bg-white/80 backdrop-blur-md shadow-sm border-b border-green-200",children:(0,n.jsx)("div",{className:"max-w-7xl mx-auto px-6 py-4 flex items-center justify-between",children:(0,n.jsxs)(r(),{href:"/",className:"flex items-center gap-2",children:[(0,n.jsx)("span",{className:"text-3xl",children:"\uD83C\uDF3F"}),(0,n.jsx)("span",{className:"text-2xl font-bold bg-gradient-to-r from-green-600 to-blue-600 bg-clip-text text-transparent",children:"GreenProof"})]})})}),(0,n.jsxs)("div",{className:"max-w-6xl mx-auto px-6 py-12 space-y-8",children:[(0,n.jsxs)("div",{className:"text-center space-y-2 animate-fade-in",children:[(0,n.jsx)("h2",{className:"text-4xl font-bold text-gray-800",children:"我的环保足迹"}),(0,n.jsx)("p",{className:"text-gray-600",children:"记录你对地球的每一份贡献"})]}),(0,n.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6 animate-slide-up",children:[(0,n.jsxs)("div",{className:"bg-white/90 backdrop-blur-sm rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all duration-300",children:[(0,n.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,n.jsx)("div",{className:"text-5xl",children:"\uD83D\uDCCA"}),(0,n.jsxs)("div",{className:"text-right",children:[(0,n.jsx)("div",{className:"text-3xl font-bold text-green-600",children:K}),(0,n.jsx)("div",{className:"text-sm text-gray-600 mt-1",children:"总行为次数"})]})]}),(0,n.jsx)("div",{className:"h-2 bg-green-100 rounded-full overflow-hidden",children:(0,n.jsx)("div",{className:"h-full bg-gradient-to-r from-green-500 to-green-600 w-3/4"})})]}),(0,n.jsxs)("div",{className:"bg-white/90 backdrop-blur-sm rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all duration-300",children:[(0,n.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,n.jsx)("div",{className:"text-5xl",children:"\uD83D\uDC9A"}),(0,n.jsxs)("div",{className:"text-right",children:[(0,n.jsx)("div",{className:"text-3xl font-bold text-blue-600",children:null!=v?v:"•••"}),(0,n.jsx)("div",{className:"text-sm text-gray-600 mt-1",children:"累计贡献 (kg CO₂)"})]})]}),(0,n.jsx)("div",{className:"h-2 bg-blue-100 rounded-full overflow-hidden",children:(0,n.jsx)("div",{className:"h-full bg-gradient-to-r from-blue-500 to-blue-600 w-2/3"})})]}),(0,n.jsxs)("div",{className:"bg-white/90 backdrop-blur-sm rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all duration-300",children:[(0,n.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,n.jsx)("div",{className:"text-5xl",children:"\uD83C\uDFC6"}),(0,n.jsxs)("div",{className:"text-right",children:[(0,n.jsx)("div",{className:"text-3xl font-bold text-yellow-600",children:"--"}),(0,n.jsx)("div",{className:"text-sm text-gray-600 mt-1",children:"获得徽章数"})]})]}),(0,n.jsx)("div",{className:"h-2 bg-yellow-100 rounded-full overflow-hidden",children:(0,n.jsx)("div",{className:"h-full bg-gradient-to-r from-yellow-500 to-orange-500 w-1/2"})})]})]}),(0,n.jsxs)("div",{className:"bg-white/90 backdrop-blur-sm rounded-2xl shadow-lg p-6 animate-slide-up",style:{animationDelay:"0.2s"},children:[(0,n.jsxs)("div",{className:"flex items-center justify-between mb-6",children:[(0,n.jsx)("h3",{className:"text-2xl font-bold text-gray-800",children:"环保记录"}),(0,n.jsxs)("div",{className:"flex items-center gap-3",children:[(0,n.jsx)("button",{className:"px-4 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition",onClick:()=>{k({}),(async()=>{if(e&&s)try{let t=await e.getUserActions(s);h(t)}catch(e){}})()},children:"\uD83D\uDD04 刷新"}),(0,n.jsx)("button",{className:"px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition disabled:opacity-50",disabled:!t||!a||!e||0===y.length||D,onClick:async()=>{if(t&&a&&e&&0!==y.length)try{var n;S(!0),A("正在解密所有记录...");let s=null!=(n=null==e?void 0:e.target)?n:null==e?void 0:e.address,r=Array.from(new Set(y.map(e=>"string"==typeof e.value||(0,d.Lo)(e.value)?e.value:(0,d.c$)(e.value)))),i=await m(t,[s],a),l=r.map(e=>({handle:e,contractAddress:s})),c=await t.userDecrypt(l,i.privateKey,i.publicKey,i.signature,i.contractAddresses,i.userAddress,i.startTimestamp,i.durationDays),o={};for(let e of r){let t=null==c?void 0:c[e],a=Number(t);Number.isNaN(a)||(o[e]=a)}k(o),A("")}catch(e){console.error("decrypt list error",e),A("解密失败：".concat((null==e?void 0:e.message)||e))}finally{S(!1)}},children:"\uD83D\uDD13 解密所有记录"})]})]}),(0,n.jsx)("div",{className:"space-y-4",children:U.map((s,r)=>(0,n.jsxs)("div",{className:"flex items-center justify-between p-4 bg-gradient-to-r from-green-50 to-blue-50 rounded-xl hover:shadow-md transition-all duration-300 group",children:[(0,n.jsxs)("div",{className:"flex items-center gap-4",children:[(0,n.jsx)("div",{className:"text-4xl",children:"\uD83C\uDF31"}),(0,n.jsxs)("div",{children:[(0,n.jsx)("div",{className:"font-semibold text-gray-800",children:s.category}),(0,n.jsx)("div",{className:"text-sm text-gray-500",children:new Date(1e3*Number(s.timestamp)).toLocaleDateString()})]})]}),(0,n.jsxs)("div",{className:"flex items-center gap-4",children:[(0,n.jsx)("div",{className:"text-right",children:(()=>{let e=C["string"==typeof s.value||(0,d.Lo)(s.value)?s.value:(0,d.c$)(s.value)];return(0,n.jsx)("div",{className:"font-bold text-green-600",children:void 0===e?"加密":"明文：".concat(e)})})()}),(0,n.jsx)("button",{className:"px-3 py-1 bg-white rounded-lg text-sm text-gray-600 hover:bg-gray-50 transition",onClick:async()=>{let n="string"==typeof s.value||(0,d.Lo)(s.value)?s.value:(0,d.c$)(s.value),r=C[n];if(void 0===r&&t&&a&&e)try{var i;w("正在解密详情...");let s=null!=(i=null==e?void 0:e.target)?i:null==e?void 0:e.address,l=await m(t,[s],a),d=await t.userDecrypt([{handle:n,contractAddress:s}],l.privateKey,l.publicKey,l.signature,l.contractAddresses,l.userAddress,l.startTimestamp,l.durationDays);r=Number(null==d?void 0:d[n]),Number.isNaN(r)||k(e=>({...e,[n]:r}))}catch(e){console.error("decrypt detail error",e)}finally{w("")}_({category:s.category,description:s.description,timestamp:s.timestamp,handle:n,clear:r}),M(!0)},children:"查看详情"})]})]},r))}),T&&(0,n.jsx)("div",{className:"mt-2 text-sm text-blue-700",children:T})]}),(0,n.jsxs)("div",{className:"text-center animate-fade-in",style:{animationDelay:"0.4s"},children:[(0,n.jsx)("button",{className:"px-8 py-4 bg-gradient-to-r from-blue-500 to-blue-600 text-white font-semibold rounded-xl shadow-lg hover:shadow-xl hover:scale-105 transition-all duration-300 disabled:opacity-50",disabled:!t||null===x,onClick:async()=>{if(t&&null!==x)try{var n,s;let r;j(!0),w("正在解密...");let i="string"==typeof x||(0,d.Lo)(x)?x:(0,d.c$)(x),l=null!=(n=null==e?void 0:e.target)?n:null==e?void 0:e.address;try{if(a&&l){let e=await m(t,[l],a),n=await t.userDecrypt([{handle:i,contractAddress:l}],e.privateKey,e.publicKey,e.signature,e.contractAddresses,e.userAddress,e.startTimestamp,e.durationDays),d="string"==typeof i?i:String(i),c=null!=(s=null==n?void 0:n[d])?s:null==n?void 0:n[Object.keys(null!=n?n:{})[0]];r=Number(c)}}catch(e){try{let e=await t.userDecrypt(i);r=Number(e)}catch(e){if("function"==typeof t.decrypt){let e=l?await t.decrypt(l,i):await t.decrypt(i);r=Number(e)}else throw e}}f(!r||isNaN(r)?0:r),w("")}catch(e){console.error("decrypt error",e),w("解密失败：".concat((null==e?void 0:e.message)||e))}finally{j(!1)}},children:"\uD83D\uDD13 解密我的累计贡献"}),(0,n.jsx)("div",{className:"mt-3 flex items-center justify-center gap-3",children:(0,n.jsx)("button",{className:"px-3 py-1 text-xs rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200",onClick:async()=>{var n;if(!t||!a||!e)return;let s=null!=(n=null==e?void 0:e.target)?n:null==e?void 0:e.address;s&&(await p(t,[s],a),w("已清除授权缓存，下次解密会重新签名"))},children:"清除授权缓存/重新签名"})}),(0,n.jsx)("p",{className:"text-sm text-gray-500 mt-3",children:"贡献值已加密存储，点击解密查看真实数值"}),b&&(0,n.jsx)("div",{className:"mt-2 text-sm text-blue-700",children:b})]}),(0,n.jsx)("div",{className:"text-center",children:(0,n.jsx)(r(),{href:"/",className:"text-green-600 hover:text-green-700 font-medium",children:"← 返回首页"})})]})]}),E&&(0,n.jsx)("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/30",children:(0,n.jsxs)("div",{className:"bg-white rounded-xl shadow-xl w-[90%] max-w-xl p-6",children:[(0,n.jsxs)("div",{className:"flex items-center justify-between mb-3",children:[(0,n.jsx)("h4",{className:"text-lg font-semibold text-gray-800",children:"记录详情"}),(0,n.jsx)("button",{className:"text-gray-500 hover:text-gray-700",onClick:()=>M(!1),children:"✕"})]}),(0,n.jsxs)("div",{className:"space-y-2 text-sm text-gray-700",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("span",{className:"font-medium",children:"类型："}),null==I?void 0:I.category]}),(0,n.jsxs)("div",{children:[(0,n.jsx)("span",{className:"font-medium",children:"时间："}),(null==I?void 0:I.timestamp)?new Date(1e3*Number(I.timestamp)).toLocaleString():"-"]}),(0,n.jsxs)("div",{children:[(0,n.jsx)("span",{className:"font-medium",children:"描述："}),(null==I?void 0:I.description)||"-"]}),(0,n.jsxs)("div",{className:"break-all",children:[(0,n.jsx)("span",{className:"font-medium",children:"句柄："}),null==I?void 0:I.handle]}),(0,n.jsxs)("div",{children:[(0,n.jsx)("span",{className:"font-medium",children:"明文："}),(null==I?void 0:I.clear)!==void 0?String(I.clear):"未解密/无数据"]})]}),(0,n.jsx)("div",{className:"mt-4 text-right",children:(0,n.jsx)("button",{className:"px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700",onClick:()=>M(!1),children:"关闭"})})]})})]})}},2842:(e,t,a)=>{"use strict";a.d(t,{v:()=>r});var n=a(2115),s=a(1408);function r(){let[e,t]=(0,n.useState)(null),[a,r]=(0,n.useState)(null),[i,l]=(0,n.useState)(""),[d,c]=(0,n.useState)(null),[o,u]=(0,n.useState)(!1),m=async()=>{let e=window.ethereum;if(!e)return void alert("请安装 MetaMask");try{var a;let n=new s.k(e);await (null==(a=e.request)?void 0:a.call(e,{method:"eth_requestAccounts"}));let i=await n.getSigner(),d=await i.getAddress(),o=await n.getNetwork();t(n),r(i),l(d),c(Number(o.chainId)),u(!0)}catch(e){console.error("连接钱包失败:",e)}};return(0,n.useEffect)(()=>{var e,a;let n=window.ethereum;if(!n)return;let i=new s.k(n);t(i),(async()=>{try{var e,t;let a=await (null==(e=n.request)?void 0:e.call(n,{method:"eth_accounts"})),s=await (null==(t=n.request)?void 0:t.call(n,{method:"eth_chainId"})),d=s?parseInt(s,16):NaN;if(c(d),a&&a.length>0){let e=await i.getSigner();r(e),l(a[0]),u(!0)}}catch(e){}})();let d=async e=>{if(!e||0===e.length){u(!1),r(null),l("");return}try{let t=await i.getSigner();r(t),l(e[0]),u(!0)}catch(e){}},o=e=>{try{c(parseInt(e,16))}catch(e){c(null)}};return null==n||null==(e=n.on)||e.call(n,"accountsChanged",d),null==n||null==(a=n.on)||a.call(n,"chainChanged",o),()=>{try{var e,t;null==n||null==(e=n.removeListener)||e.call(n,"accountsChanged",d),null==n||null==(t=n.removeListener)||t.call(n,"chainChanged",o)}catch(e){}}},[]),{provider:e,signer:a,address:i,chainId:d,isConnected:o,connect:m,switchToSepolia:async()=>{var e,t,a;let n=window.ethereum;if(n)try{await (null==(e=n.request)?void 0:e.call(n,{method:"wallet_switchEthereumChain",params:[{chainId:"0xaa36a7"}]}))}catch(e){if((null==e?void 0:e.code)===4902||(null==e||null==(t=e.message)?void 0:t.includes("Unrecognized chain ID")))try{await (null==(a=n.request)?void 0:a.call(n,{method:"wallet_addEthereumChain",params:[{chainId:"0xaa36a7",chainName:"Sepolia",rpcUrls:["https://ethereum-sepolia-rpc.publicnode.com"],nativeCurrency:{name:"SepoliaETH",symbol:"ETH",decimals:18},blockExplorerUrls:["https://sepolia.etherscan.io"]}]}))}catch(e){}}}}}},4202:(e,t,a)=>{Promise.resolve().then(a.bind(a,1767))},6212:(e,t,a)=>{"use strict";a.d(t,{X:()=>c});var n=a(2115),s=a(8678),r=a(2842);async function i(){if(window.relayerSDK)return window.relayerSDK;await new Promise((e,t)=>{let a=document.createElement("script");a.src="https://cdn.zama.ai/relayer-sdk-js/0.2.0/relayer-sdk-js.umd.cjs",a.async=!0,a.type="text/javascript",a.onload=()=>{if(!window.relayerSDK||"function"!=typeof window.relayerSDK.createInstance)return void t(Error("relayerSDK UMD not available"));e()},a.onerror=()=>t(Error("Failed to load relayer SDK UMD")),document.head.appendChild(a)});let e=window.relayerSDK;if(!e)throw Error("relayerSDK UMD not available after load");return e}let l=JSON.parse('[{"inputs":[{"internalType":"address","name":"badgeAddress","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"category","type":"string"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"ActionRecorded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint8","name":"level","type":"uint8"}],"name":"BadgeMinted","type":"event"},{"inputs":[],"name":"BADGE_LV1_COUNT","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"BADGE_LV2_COUNT","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"badge","outputs":[{"internalType":"contract IGreenBadgeNFT","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint32","name":"inc","type":"uint32"},{"internalType":"uint32","name":"capPlain","type":"uint32"}],"name":"cappedAccumulate","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"limit","type":"uint256"}],"name":"getTopUsers","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getTotalActions","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getUserActions","outputs":[{"components":[{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"string","name":"category","type":"string"},{"internalType":"string","name":"description","type":"string"},{"internalType":"euint32","name":"value","type":"bytes32"}],"internalType":"struct GreenProof.Action[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getUserEncryptedCount","outputs":[{"internalType":"euint32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getUserEncryptedSum","outputs":[{"internalType":"euint32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"}],"name":"grantAccess","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"}],"name":"grantTransientAccess","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"},{"internalType":"externalEuint32","name":"threshold","type":"bytes32"},{"internalType":"bytes","name":"proof","type":"bytes"}],"name":"isCountAtLeast","outputs":[{"internalType":"ebool","name":"","type":"bytes32"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint8","name":"level","type":"uint8"}],"name":"mintBadge","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"protocolId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"pure","type":"function"},{"inputs":[{"internalType":"string","name":"category","type":"string"},{"internalType":"string","name":"description","type":"string"},{"internalType":"externalEuint32","name":"inputValue32","type":"bytes32"},{"internalType":"bytes","name":"inputProof","type":"bytes"}],"name":"recordAction","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"userActionCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}]'),d=JSON.parse('{"sepolia":{"address":"0x1E19d64C600724deC2a00bFA506d6190Df03AEb9","chainName":"sepolia"}}');function c(){let{provider:e,signer:t,address:a,chainId:c,isConnected:o}=(0,r.v)(),[u,m]=(0,n.useState)(null),[p,y]=(0,n.useState)(null),[h,x]=(0,n.useState)("idle"),[g,v]=(0,n.useState)(null);return(0,n.useEffect)(()=>{var e;if(!t)return void m(null);let a=null==d||null==(e=d.sepolia)?void 0:e.address;if(!a)return void m(null);m(new s.NZ(a,l,t))},[t]),(0,n.useEffect)(()=>{!async function(){if(o&&c){if(0xaa36a7!==c){x("error"),v(Error("请切换到 Sepolia 网络")),y(null);return}try{x("loading"),v(null);let t=await i();await t.initSDK();let a=window.ethereum||void 0,n=await t.createInstance({...t.SepoliaConfig,network:null!=a?a:e});y(n),x("ready")}catch(t){try{let t=await i();await t.initSDK();let a=window.ethereum||void 0,n=await t.createInstance({...t.SepoliaConfig,network:null!=a?a:e});y(n),x("ready")}catch(e){x("error"),v(e),y(null)}}}}()},[o,c,e]),{contract:u,fhevmInstance:p,provider:e,signer:t,address:a,isConnected:o,chainId:c,fheStatus:h,fheError:g}}}},e=>{e.O(0,[770,441,255,358],()=>e(e.s=4202)),_N_E=e.O()}]);